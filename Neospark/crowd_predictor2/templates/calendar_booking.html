{% extends "base.html" %}

{% block title %}Book Darshan - {{ temple.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4><i class="bi bi-calendar-check"></i> Select Date - {{ temple.name }}</h4>
            </div>
            <div class="card-body">
                <div id="calendar-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-outline-primary" id="prevMonth">&lt; Previous</button>
                        <h5 id="monthYear"></h5>
                        <button class="btn btn-outline-primary" id="nextMonth">Next &gt;</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
                
                <div class="mt-4">
                    <h6>Crowd Prediction Legend:</h6>
                    <div class="d-flex gap-3">
                        <span><span class="badge" style="background-color: #28a745;">&nbsp;&nbsp;</span> Low Crowd</span>
                        <span><span class="badge" style="background-color: #ffc107;">&nbsp;&nbsp;</span> Medium Crowd</span>
                        <span><span class="badge" style="background-color: #dc3545;">&nbsp;&nbsp;</span> High Crowd</span>
                    </div>
                    <small class="text-muted">Based on historical data, festivals, and events</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h6>Temple Information</h6>
            </div>
            <div class="card-body">
                <img src="{{ temple.image_url }}" class="img-fluid rounded mb-3" alt="{{ temple.name }}">
                <h6>{{ temple.name }}</h6>
                <p class="text-muted small">{{ temple.location }}</p>
                <p class="small">{{ temple.description }}</p>
                
                <div class="mt-3">
                    <strong>Timings:</strong><br>
                    <small>{{ temple.opening_time }} - {{ temple.closing_time }}</small>
                </div>
                
                <div class="mt-3">
                    <strong>Capacity:</strong><br>
                    <small>{{ temple.capacity }} people</small>
                </div>
            </div>
        </div>
        
        <div class="card shadow mt-3" id="selectedDateCard" style="display: none;">
            <div class="card-header bg-warning text-dark">
                <h6>Selected Date</h6>
            </div>
            <div class="card-body">
                <p><strong>Date:</strong> <span id="selectedDate"></span></p>
                <p><strong>Predicted Crowd:</strong> <span id="predictedCrowd" class="badge"></span></p>
                <button class="btn btn-primary w-100" id="proceedBooking">Proceed to Time Slots</button>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 20px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}

.calendar-day:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.calendar-day.selected {
    border: 3px solid #007bff;
    transform: scale(1.1);
}

.calendar-day.disabled {
    background-color: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}

.calendar-day.disabled:hover {
    transform: none;
    box-shadow: none;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
    font-weight: bold;
    text-align: center;
}
</style>

<script>
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let selectedDate = null;
const templeId = {{ temple.id }};
const templeName = "{{ temple.name }}";

const monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"];
const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

function generateCalendar(month, year) {
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    
    document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;
    
    let calendarHTML = '<div class="calendar-header">';
    dayNames.forEach(day => {
        calendarHTML += `<div>${day}</div>`;
    });
    calendarHTML += '</div>';
    
    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        calendarHTML += '<div class="calendar-day disabled"></div>';
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isPast = date < today.setHours(0,0,0,0);
        
        // Get crowd prediction for this date
        getCrowdPrediction(dateStr, day, isPast);
    }
    
    document.getElementById('calendarGrid').innerHTML = calendarHTML;
}

function getCrowdPrediction(dateStr, day, isPast) {
    fetch(`/api/available-slots?temple_id=${templeId}&date=${dateStr}`)
        .then(response => response.json())
        .then(data => {
            const crowdLevel = data.predicted_crowd || 'low';
            const color = getCrowdColor(crowdLevel);
            
            const dayElement = document.createElement('div');
            dayElement.className = `calendar-day ${isPast ? 'disabled' : ''}`;
            dayElement.style.backgroundColor = color;
            dayElement.style.color = crowdLevel === 'medium' ? '#000' : '#fff';
            dayElement.textContent = day;
            dayElement.dataset.date = dateStr;
            dayElement.dataset.crowd = crowdLevel;
            
            if (!isPast) {
                dayElement.addEventListener('click', () => selectDate(dateStr, crowdLevel));
            }
            
            document.getElementById('calendarGrid').appendChild(dayElement);
        })
        .catch(() => {
            // Fallback if API fails
            const dayElement = document.createElement('div');
            dayElement.className = `calendar-day ${isPast ? 'disabled' : ''}`;
            dayElement.style.backgroundColor = '#6c757d';
            dayElement.style.color = '#fff';
            dayElement.textContent = day;
            dayElement.dataset.date = dateStr;
            
            if (!isPast) {
                dayElement.addEventListener('click', () => selectDate(dateStr, 'low'));
            }
            
            document.getElementById('calendarGrid').appendChild(dayElement);
        });
}

function getCrowdColor(crowdLevel) {
    const colors = {
        'low': '#28a745',
        'medium': '#ffc107', 
        'high': '#dc3545'
    };
    return colors[crowdLevel] || '#6c757d';
}

function selectDate(dateStr, crowdLevel) {
    // Remove previous selection
    document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
    });
    
    // Add selection to clicked day
    event.target.classList.add('selected');
    
    selectedDate = dateStr;
    document.getElementById('selectedDate').textContent = new Date(dateStr).toLocaleDateString();
    document.getElementById('predictedCrowd').textContent = crowdLevel.charAt(0).toUpperCase() + crowdLevel.slice(1);
    document.getElementById('predictedCrowd').className = `badge bg-${crowdLevel === 'low' ? 'success' : crowdLevel === 'medium' ? 'warning' : 'danger'}`;
    document.getElementById('selectedDateCard').style.display = 'block';
}

document.getElementById('prevMonth').addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    generateCalendar(currentMonth, currentYear);
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    generateCalendar(currentMonth, currentYear);
});

document.getElementById('proceedBooking').addEventListener('click', () => {
    if (selectedDate) {
        window.location.href = `/temple/${templeId}?date=${selectedDate}`;
    }
});

// Initialize calendar
generateCalendar(currentMonth, currentYear);
</script>
{% endblock %}