{% extends "base.html" %}

{% block title %}Smart Queue Management - VAC AI System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-traffic-cone"></i> Smart Queue Management - VAC AI System</h2>
        <p class="text-muted">AI-powered queue control similar to Vehicle Actuated Control traffic signals</p>
    </div>
</div>

<!-- Alert Banner -->
<div id="alertBanner" class="row mb-3" style="display: none;">
    <div class="col-12">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong><i class="bi bi-exclamation-triangle"></i> CRITICAL QUEUE ALERT!</strong>
            <span id="alertMessage"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>

<!-- Image Upload Panel -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow border-success">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-camera"></i> Queue Zone Image Upload</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white text-center">
                                <h6>Entry Queue</h6>
                            </div>
                            <div class="card-body text-center">
                                <button class="btn btn-primary mb-2" onclick="startCamera('entry')">
                                    <i class="bi bi-camera"></i> Start Camera
                                </button>
                                <div id="entryPreview" class="border rounded p-2" style="height: 120px; background: #f8f9fa;">
                                    <video id="entryVideo" style="display: none; width: 100%; height: 120px; object-fit: cover;"></video>
                                    <canvas id="entryCanvas" style="display: none; width: 100%; height: 120px;"></canvas>
                                    <div id="entryPlaceholder">
                                        <i class="bi bi-camera text-muted"></i>
                                        <p class="small text-muted mb-0">Click to start camera</p>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="captureImage('entry')" style="display: none;" id="entryCaptureBtn">
                                    <i class="bi bi-camera-fill"></i> Capture
                                </button>
                                <div id="entryCount" class="mt-2" style="display: none;">
                                    <span class="badge bg-primary fs-6">ðŸ‘¥ <span id="entryPeopleCount">0</span> People</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white text-center">
                                <h6>Darshan Queue</h6>
                            </div>
                            <div class="card-body text-center">
                                <button class="btn btn-success mb-2" onclick="startCamera('darshan')">
                                    <i class="bi bi-camera"></i> Start Camera
                                </button>
                                <div id="darshanPreview" class="border rounded p-2" style="height: 120px; background: #f8f9fa;">
                                    <video id="darshanVideo" style="display: none; width: 100%; height: 120px; object-fit: cover;"></video>
                                    <canvas id="darshanCanvas" style="display: none; width: 100%; height: 120px;"></canvas>
                                    <div id="darshanPlaceholder">
                                        <i class="bi bi-camera text-muted"></i>
                                        <p class="small text-muted mb-0">Click to start camera</p>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="captureImage('darshan')" style="display: none;" id="darshanCaptureBtn">
                                    <i class="bi bi-camera-fill"></i> Capture
                                </button>
                                <div id="darshanCount" class="mt-2" style="display: none;">
                                    <span class="badge bg-success fs-6">ðŸ‘¥ <span id="darshanPeopleCount">0</span> People</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark text-center">
                                <h6>Prasad Queue</h6>
                            </div>
                            <div class="card-body text-center">
                                <button class="btn btn-warning mb-2" onclick="startCamera('prasad')">
                                    <i class="bi bi-camera"></i> Start Camera
                                </button>
                                <div id="prasadPreview" class="border rounded p-2" style="height: 120px; background: #f8f9fa;">
                                    <video id="prasadVideo" style="display: none; width: 100%; height: 120px; object-fit: cover;"></video>
                                    <canvas id="prasadCanvas" style="display: none; width: 100%; height: 120px;"></canvas>
                                    <div id="prasadPlaceholder">
                                        <i class="bi bi-camera text-muted"></i>
                                        <p class="small text-muted mb-0">Click to start camera</p>
                                    </div>
                                </div>
                                <button class="btn btn-warning btn-sm" onclick="captureImage('prasad')" style="display: none;" id="prasadCaptureBtn">
                                    <i class="bi bi-camera-fill"></i> Capture
                                </button>
                                <div id="prasadCount" class="mt-2" style="display: none;">
                                    <span class="badge bg-warning fs-6">ðŸ‘¥ <span id="prasadPeopleCount">0</span> People</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white text-center">
                                <h6>Exit Queue</h6>
                            </div>
                            <div class="card-body text-center">
                                <button class="btn btn-info mb-2" onclick="startCamera('exit')">
                                    <i class="bi bi-camera"></i> Start Camera
                                </button>
                                <div id="exitPreview" class="border rounded p-2" style="height: 120px; background: #f8f9fa;">
                                    <video id="exitVideo" style="display: none; width: 100%; height: 120px; object-fit: cover;"></video>
                                    <canvas id="exitCanvas" style="display: none; width: 100%; height: 120px;"></canvas>
                                    <div id="exitPlaceholder">
                                        <i class="bi bi-camera text-muted"></i>
                                        <p class="small text-muted mb-0">Click to start camera</p>
                                    </div>
                                </div>
                                <button class="btn btn-info btn-sm" onclick="captureImage('exit')" style="display: none;" id="exitCaptureBtn">
                                    <i class="bi bi-camera-fill"></i> Capture
                                </button>
                                <div id="exitCount" class="mt-2" style="display: none;">
                                    <span class="badge bg-info fs-6">ðŸ‘¥ <span id="exitPeopleCount">0</span> People</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <button class="btn btn-primary" onclick="analyzeAllImages()">
                            <i class="bi bi-cpu"></i> Analyze All Queue Images
                        </button>
                        <button class="btn btn-warning ms-2" onclick="forceRedirectionSystem()">
                            <i class="bi bi-arrow-left-right"></i> Force AI Redirection
                        </button>
                        <button class="btn btn-danger ms-2" onclick="stopAllCameras()">
                            <i class="bi bi-camera-video-off"></i> Stop All Cameras
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Control Panel -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow border-primary">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-cpu"></i> AI Queue Control Center</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Select Temple</label>
                        <select class="form-select" id="templeSelect">
                            <option value="">Choose temple...</option>
                            {% for temple in temples %}
                            <option value="{{ temple.id }}">{{ temple.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">AI Analysis Mode</label>
                        <select class="form-select" id="analysisMode">
                            <option value="realtime">Real-time Analysis</option>
                            <option value="predictive">Predictive Analysis</option>
                            <option value="optimization">Optimization Mode</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-success me-2" onclick="startAIAnalysis()">
                            <i class="bi bi-play-circle"></i> Start AI Analysis
                        </button>
                        <button class="btn btn-warning me-2" onclick="emergencyRelease()">
                            <i class="bi bi-exclamation-triangle"></i> Emergency Release
                        </button>
                        <button class="btn btn-info" onclick="optimizeAllQueues()">
                            <i class="bi bi-gear"></i> Auto-Optimize
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow border-success">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-speedometer2"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div id="systemStatus">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Initializing AI System...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Priority Queue Display -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="bi bi-arrow-up-circle"></i> Priority Queue - Release First</h5>
            </div>
            <div class="card-body">
                <div id="priorityQueueDisplay">
                    <div class="text-center text-muted">
                        <i class="bi bi-hourglass-split fs-1"></i>
                        <p>Start AI analysis to see priority queue recommendations</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Crowd Redirection System -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="bi bi-arrow-left-right"></i> AI Crowd Redirection System</h5>
            </div>
            <div class="card-body">
                <div id="redirectionRecommendations">
                    <div class="text-center text-muted">
                        <i class="bi bi-robot fs-1"></i>
                        <p>Start camera analysis to get AI redirection recommendations</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>







<!-- Audio Alert -->
<audio id="alertSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
</audio>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentTempleId = null;
let aiAnalysisInterval = null;
let predictionChart = null;

// Initialize AI system
document.addEventListener('DOMContentLoaded', function() {
    updateSystemStatus('Ready', 'success');
    setupImagePreviews();
});

let cameraStreams = {};
let capturedImages = {};
let peopleCounters = {};
let detectionActive = {};

function setupImagePreviews() {
    // Camera functionality will be handled by startCamera function
}

async function startCamera(zone) {
    try {
        const video = document.getElementById(zone + 'Video');
        const placeholder = document.getElementById(zone + 'Placeholder');
        const captureBtn = document.getElementById(zone + 'CaptureBtn');
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            } 
        });
        
        cameraStreams[zone] = stream;
        video.srcObject = stream;
        video.play();
        
        placeholder.style.display = 'none';
        video.style.display = 'block';
        captureBtn.style.display = 'inline-block';
        document.getElementById(zone + 'Count').style.display = 'block';
        
        // Start people counting
        startPeopleDetection(zone);
        
        // Force initial redirection recommendations
        setTimeout(() => {
            updateRedirectionRecommendations();
        }, 2000);
        
    } catch (error) {
        console.error('Camera access error:', error);
        alert('Camera access denied or not available. Please check permissions.');
    }
}

function captureImage(zone) {
    const video = document.getElementById(zone + 'Video');
    const canvas = document.getElementById(zone + 'Canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    // Convert to blob for analysis
    canvas.toBlob(function(blob) {
        capturedImages[zone] = blob;
        
        // Show captured image
        video.style.display = 'none';
        canvas.style.display = 'block';
        
        // Stop camera stream and detection
        if (cameraStreams[zone]) {
            cameraStreams[zone].getTracks().forEach(track => track.stop());
            delete cameraStreams[zone];
        }
        
        detectionActive[zone] = false;
        
        alert(`Image captured for ${zone} queue zone`);
    }, 'image/jpeg', 0.8);
}

function stopAllCameras() {
    Object.keys(cameraStreams).forEach(zone => {
        if (cameraStreams[zone]) {
            cameraStreams[zone].getTracks().forEach(track => track.stop());
            delete cameraStreams[zone];
        }
        
        // Stop people detection
        detectionActive[zone] = false;
        
        const video = document.getElementById(zone + 'Video');
        const canvas = document.getElementById(zone + 'Canvas');
        const placeholder = document.getElementById(zone + 'Placeholder');
        const captureBtn = document.getElementById(zone + 'CaptureBtn');
        const countDiv = document.getElementById(zone + 'Count');
        
        video.style.display = 'none';
        canvas.style.display = 'none';
        placeholder.style.display = 'block';
        captureBtn.style.display = 'none';
        countDiv.style.display = 'none';
    });
    
    alert('All cameras stopped');
}

function startPeopleDetection(zone) {
    const video = document.getElementById(zone + 'Video');
    detectionActive[zone] = true;
    
    function updateCount() {
        if (!detectionActive[zone]) return;
        
        const peopleCount = countPeopleInFrame(null, zone);
        document.getElementById(zone + 'PeopleCount').textContent = peopleCount;
        peopleCounters[zone] = peopleCount;
        
        updateCounterColor(zone, peopleCount);
        updateRedirectionRecommendations();
        
        setTimeout(updateCount, 5000); // Update every 5 seconds
    }
    
    updateCount();
}

function countPeopleInFrame(imageData, zone) {
    // Simplified people counting simulation
    const baseCounts = {
        'entry': 5,
        'darshan': 12,
        'prasad': 7,
        'exit': 3
    };
    
    let estimatedPeople = baseCounts[zone] || 5;
    
    // Add realistic variation
    const variation = Math.floor(Math.random() * 6) - 3; // -3 to +3
    estimatedPeople += variation;
    
    return Math.max(1, Math.min(estimatedPeople, 25));
}

function updateCounterColor(zone, count) {
    const countElement = document.getElementById(zone + 'PeopleCount').parentElement;
    
    if (count > 15) {
        countElement.className = 'badge bg-danger fs-6';
    } else if (count > 10) {
        countElement.className = 'badge bg-warning fs-6';
    } else {
        const colors = {
            'entry': 'bg-primary',
            'darshan': 'bg-success', 
            'prasad': 'bg-warning',
            'exit': 'bg-info'
        };
        countElement.className = `badge ${colors[zone]} fs-6`;
    }
}

function updateRedirectionRecommendations() {
    // Force realistic counts for demo
    const counts = {
        entry: peopleCounters.entry || 15,
        darshan: peopleCounters.darshan || 18,
        prasad: peopleCounters.prasad || 6,
        exit: peopleCounters.exit || 4
    };
    
    console.log('Updating redirection with counts:', counts);
    const recommendations = generateRedirectionRecommendations(counts);
    console.log('Generated recommendations:', recommendations);
    displayRedirectionRecommendations(recommendations);
}

function generateRedirectionRecommendations(counts) {
    const recommendations = [];
    const queueLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
    
    function getRandomQueues() {
        const from = queueLetters[Math.floor(Math.random() * queueLetters.length)];
        let to = queueLetters[Math.floor(Math.random() * queueLetters.length)];
        while (to === from) {
            to = queueLetters[Math.floor(Math.random() * queueLetters.length)];
        }
        return { from, to };
    }
    
    // Entry Queue Redirections - Force recommendations
    if (counts.entry > 10) {
        if (counts.prasad < 10) {
            const queues = getRandomQueues();
            recommendations.push({
                domain: 'Entry Management',
                from: `Entry Queue ${queues.from}`,
                to: `Prasad Queue ${queues.to}`, 
                fromCount: counts.entry,
                toCount: counts.prasad,
                priority: counts.entry > 18 ? 'CRITICAL' : 'HIGH',
                color: counts.entry > 18 ? 'danger' : 'warning',
                peopleToRedirect: Math.floor((counts.entry - counts.prasad) / 2),
                instruction: `Redirect devotees from Entry Queue ${queues.from} â†’ Prasad Collection Queue ${queues.to}`
            });
        }
        if (counts.darshan < 6) {
            const queues = getRandomQueues();
            recommendations.push({
                domain: 'Entry Management',
                from: `Entry Queue ${queues.from}`,
                to: `Darshan Queue ${queues.to}`,
                fromCount: counts.entry,
                toCount: counts.darshan,
                priority: 'MEDIUM',
                color: 'info',
                peopleToRedirect: Math.floor((counts.entry - counts.darshan) / 2),
                instruction: `Direct new arrivals from Entry Queue ${queues.from} â†’ Darshan Queue ${queues.to}`
            });
        }
    }
    
    // Darshan Queue Redirections - Force recommendations  
    if (counts.darshan > 12) {
        if (counts.prasad < 12) {
            const queues = getRandomQueues();
            recommendations.push({
                domain: 'Darshan Management',
                from: `Darshan Queue ${queues.from}`,
                to: `Prasad Queue ${queues.to}`,
                fromCount: counts.darshan,
                toCount: counts.prasad,
                priority: counts.darshan > 20 ? 'CRITICAL' : 'HIGH',
                color: counts.darshan > 20 ? 'danger' : 'warning',
                peopleToRedirect: Math.floor((counts.darshan - counts.prasad) / 2),
                instruction: `Guide waiting devotees from Darshan Queue ${queues.from} â†’ Prasad Collection Queue ${queues.to}`
            });
        }
        if (counts.exit < 5) {
            const queues = getRandomQueues();
            recommendations.push({
                domain: 'Darshan Management', 
                from: `Darshan Queue ${queues.from}`,
                to: `Exit Queue ${queues.to}`,
                fromCount: counts.darshan,
                toCount: counts.exit,
                priority: 'MEDIUM',
                color: 'info',
                peopleToRedirect: Math.floor((counts.darshan - counts.exit) / 2),
                instruction: `Direct completed devotees from Darshan Queue ${queues.from} â†’ Exit Queue ${queues.to}`
            });
        }
    }
    
    // Prasad Queue Redirections - Force recommendations
    if (counts.prasad > 8) {
        if (counts.exit < 10) {
            const queues = getRandomQueues();
            recommendations.push({
                domain: 'Prasad Management',
                from: `Prasad Queue ${queues.from}`,
                to: `Exit Queue ${queues.to}`,
                fromCount: counts.prasad,
                toCount: counts.exit,
                priority: counts.prasad > 18 ? 'CRITICAL' : 'HIGH',
                color: counts.prasad > 18 ? 'danger' : 'warning',
                peopleToRedirect: Math.floor((counts.prasad - counts.exit) / 2),
                instruction: `Speed up prasad distribution from Prasad Queue ${queues.from} â†’ Exit Queue ${queues.to}`
            });
        }
        if (counts.darshan < 8) {
            const queues = getRandomQueues();
            recommendations.push({
                domain: 'Prasad Management',
                from: `Prasad Queue ${queues.from}`, 
                to: `Darshan Queue ${queues.to}`,
                fromCount: counts.prasad,
                toCount: counts.darshan,
                priority: 'MEDIUM',
                color: 'info',
                peopleToRedirect: Math.floor((counts.prasad - counts.darshan) / 2),
                instruction: `Redirect excess devotees from Prasad Queue ${queues.from} â†’ Darshan Queue ${queues.to} for worship`
            });
        }
    }
    
    return recommendations.slice(0, 4);
}

function displayRedirectionRecommendations(recommendations) {
    const container = document.getElementById('redirectionRecommendations');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center text-success">
                <i class="bi bi-check-circle fs-1"></i>
                <h5 class="text-success mt-2">Optimal Queue Distribution</h5>
                <p>All domain queues are balanced. No Aâ†’B redirection needed.</p>
            </div>
        `;
        return;
    }
    
    const recommendationsHtml = recommendations.map(rec => `
        <div class="card border-${rec.color} mb-3">
            <div class="card-header bg-${rec.color} text-white">
                <h6 class="mb-0">
                    <i class="bi bi-arrow-left-right"></i> ${rec.domain}
                    <span class="badge bg-light text-dark ms-2">${rec.priority}</span>
                </h6>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="text-${rec.color} mb-2">${rec.from} â†’ ${rec.to}</h5>
                        <p class="mb-2">${rec.instruction}</p>
                        <small class="text-muted">
                            <strong>People to redirect:</strong> ${rec.peopleToRedirect} devotees
                        </small>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <div class="text-center me-3">
                                <div class="badge bg-danger fs-6">${rec.fromCount}</div>
                                <div class="small fw-bold">Queue A</div>
                            </div>
                            <i class="bi bi-arrow-right fs-2 text-${rec.color}"></i>
                            <div class="text-center ms-3">
                                <div class="badge bg-success fs-6">${rec.toCount}</div>
                                <div class="small fw-bold">Queue B</div>
                            </div>
                        </div>
                        <button class="btn btn-${rec.color} btn-sm" onclick="executeQueueRedirection('${rec.from}', '${rec.to}', ${rec.peopleToRedirect}, '${rec.domain}')">
                            <i class="bi bi-arrow-right-circle"></i> Execute Aâ†’B
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = recommendationsHtml;
}

function executeQueueRedirection(fromQueue, toQueue, peopleCount, domain) {
    if (confirm(`Execute ${domain} redirection?\n\n${fromQueue} â†’ ${toQueue}\nRedirect ${peopleCount} devotees`)) {
        alert(`âœ… Queue Redirection Executed\n\n${domain}:\n${fromQueue} â†’ ${toQueue}\n${peopleCount} devotees redirected successfully`);
        
        // Extract zone names from queue names
        const fromZone = fromQueue.toLowerCase().includes('entry') ? 'entry' :
                        fromQueue.toLowerCase().includes('darshan') ? 'darshan' :
                        fromQueue.toLowerCase().includes('prasad') ? 'prasad' : 'exit';
        
        const toZone = toQueue.toLowerCase().includes('entry') ? 'entry' :
                      toQueue.toLowerCase().includes('darshan') ? 'darshan' :
                      toQueue.toLowerCase().includes('prasad') ? 'prasad' : 'exit';
        
        // Update counters
        if (peopleCounters[fromZone]) {
            peopleCounters[fromZone] = Math.max(0, peopleCounters[fromZone] - peopleCount);
            document.getElementById(fromZone + 'PeopleCount').textContent = peopleCounters[fromZone];
        }
        if (peopleCounters[toZone]) {
            peopleCounters[toZone] += peopleCount;
            document.getElementById(toZone + 'PeopleCount').textContent = peopleCounters[toZone];
        }
        
        setTimeout(updateRedirectionRecommendations, 1000);
    }
}

function forceRedirectionSystem() {
    // Force high counts to trigger recommendations
    peopleCounters.entry = 16;
    peopleCounters.darshan = 20;
    peopleCounters.prasad = 5;
    peopleCounters.exit = 3;
    
    // Update display
    document.getElementById('entryPeopleCount').textContent = peopleCounters.entry;
    document.getElementById('darshanPeopleCount').textContent = peopleCounters.darshan;
    document.getElementById('prasadPeopleCount').textContent = peopleCounters.prasad;
    document.getElementById('exitPeopleCount').textContent = peopleCounters.exit;
    
    // Show count badges
    document.getElementById('entryCount').style.display = 'block';
    document.getElementById('darshanCount').style.display = 'block';
    document.getElementById('prasadCount').style.display = 'block';
    document.getElementById('exitCount').style.display = 'block';
    
    // Force redirection recommendations
    updateRedirectionRecommendations();
    
    alert('AI Redirection System Activated! Check the recommendations below.');
}



function analyzeAllImages() {
    const zones = ['entry', 'darshan', 'prasad', 'exit'];
    let hasImages = false;
    
    zones.forEach(zone => {
        if (capturedImages[zone]) {
            hasImages = true;
        }
    });
    
    if (!hasImages) {
        alert('Please capture at least one queue zone image using the camera');
        return;
    }
    
    const templeId = document.getElementById('templeSelect').value;
    if (!templeId) {
        alert('Please select a temple first');
        return;
    }
    
    updateSystemStatus('Analyzing Images...', 'warning');
    
    // Create FormData for API call
    const formData = new FormData();
    zones.forEach(zone => {
        if (capturedImages[zone]) {
            formData.append(zone + '_image', capturedImages[zone], zone + '_capture.jpg');
        }
    });
    formData.append('temple_id', templeId);
    
    // Send to backend for analysis
    fetch('/api/analyze-queue-images', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayImageAnalysisResults(data.results);
            updateSystemStatus('Analysis Complete', 'success');
        } else {
            alert('Analysis failed: ' + data.error);
            updateSystemStatus('Analysis Failed', 'danger');
        }
    })
    .catch(error => {
        console.error('Analysis error:', error);
        // Fallback to mock results for demo
        const mockResults = {
            entry: Math.floor(Math.random() * 20) + 5,
            darshan: Math.floor(Math.random() * 30) + 10,
            prasad: Math.floor(Math.random() * 15) + 3,
            exit: Math.floor(Math.random() * 10) + 2
        };
        displayImageAnalysisResults(mockResults);
        updateSystemStatus('Analysis Complete (Demo Mode)', 'success');
    });
}

function displayImageAnalysisResults(results) {
    const resultsHtml = `
        <div class="alert alert-success">
            <h6><i class="bi bi-check-circle"></i> Image Analysis Results:</h6>
            <div class="row text-center">
                <div class="col-3"><span class="badge bg-primary">Entry: ${results.entry}</span></div>
                <div class="col-3"><span class="badge bg-success">Darshan: ${results.darshan}</span></div>
                <div class="col-3"><span class="badge bg-warning">Prasad: ${results.prasad}</span></div>
                <div class="col-3"><span class="badge bg-info">Exit: ${results.exit}</span></div>
            </div>
        </div>
    `;
    
    // Insert results after the image upload panel
    const uploadPanel = document.querySelector('.row.mb-4');
    const existingResults = document.getElementById('imageResults');
    if (existingResults) {
        existingResults.remove();
    }
    
    const resultsDiv = document.createElement('div');
    resultsDiv.id = 'imageResults';
    resultsDiv.className = 'row mb-4';
    resultsDiv.innerHTML = `<div class="col-12">${resultsHtml}</div>`;
    uploadPanel.insertAdjacentElement('afterend', resultsDiv);
}

function startAIAnalysis() {
    const templeId = document.getElementById('templeSelect').value;
    if (!templeId) {
        alert('Please select a temple first');
        return;
    }
    
    currentTempleId = templeId;
    updateSystemStatus('Analyzing...', 'warning');
    
    // Start continuous AI analysis
    if (aiAnalysisInterval) {
        clearInterval(aiAnalysisInterval);
    }
    
    performAIAnalysis();
    aiAnalysisInterval = setInterval(performAIAnalysis, 10000); // Every 10 seconds
}

function performAIAnalysis() {
    if (!currentTempleId) return;
    
    fetch(`/api/smart-queue-analysis/${currentTempleId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus('Active', 'success');
            updatePriorityQueue(data.priority_analysis);

            
            // Check for critical alerts
            checkCriticalAlerts(data.alerts);
        } else {
            updateSystemStatus('Error', 'danger');
        }
    })
    .catch(error => {
        console.error('AI Analysis Error:', error);
        updateSystemStatus('Connection Error', 'danger');
    });
}

function updateSystemStatus(status, type) {
    const statusColors = {
        'success': 'text-success',
        'warning': 'text-warning', 
        'danger': 'text-danger',
        'info': 'text-info'
    };
    
    document.getElementById('systemStatus').innerHTML = `
        <div class="text-center">
            <i class="bi bi-circle-fill ${statusColors[type]} fs-1"></i>
            <h5 class="mt-2 ${statusColors[type]}">${status}</h5>
            <small class="text-muted">Last Update: ${new Date().toLocaleTimeString()}</small>
        </div>
    `;
}

function updatePriorityQueue(priorityAnalysis) {
    if (!priorityAnalysis) return;
    
    const priorityQueue = priorityAnalysis.priority_queue;
    const priorityScore = priorityAnalysis.priority_score;
    
    let alertLevel = 'success';
    let alertText = 'Normal';
    
    if (priorityScore > 40) {
        alertLevel = 'danger';
        alertText = 'CRITICAL - Release Immediately';
    } else if (priorityScore > 25) {
        alertLevel = 'warning';
        alertText = 'HIGH - Priority Release';
    } else if (priorityScore > 15) {
        alertLevel = 'info';
        alertText = 'MEDIUM - Monitor Closely';
    }
    
    document.getElementById('priorityQueueDisplay').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-${alertLevel}">
                    <div class="card-body text-center">
                        <h3 class="text-${alertLevel}">${priorityQueue.toUpperCase()} QUEUE</h3>
                        <div class="badge bg-${alertLevel} fs-6 mb-2">${alertText}</div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-${alertLevel}" style="width: ${Math.min(priorityScore, 100)}%"></div>
                        </div>
                        <small>Priority Score: ${priorityScore.toFixed(1)}/100</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6>Pressure Analysis:</h6>
                ${Object.entries(priorityAnalysis.pressure_scores).map(([queue, score]) => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span>${queue.charAt(0).toUpperCase() + queue.slice(1)}:</span>
                        <div class="progress" style="width: 60%;">
                            <div class="progress-bar ${score > 30 ? 'bg-danger' : score > 15 ? 'bg-warning' : 'bg-success'}" 
                                 style="width: ${Math.min(score * 2, 100)}%"></div>
                        </div>
                        <span class="badge bg-secondary">${score.toFixed(1)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}











function checkCriticalAlerts(alerts) {
    const criticalAlerts = alerts.filter(alert => alert.type === 'CRITICAL' || alert.sound);
    
    if (criticalAlerts.length > 0) {
        // Show banner alert
        document.getElementById('alertMessage').textContent = criticalAlerts[0].message;
        document.getElementById('alertBanner').style.display = 'block';
        
        // Play sound alert
        document.getElementById('alertSound').play().catch(e => console.log('Audio play failed'));
        
        // Flash page title
        let originalTitle = document.title;
        let flashCount = 0;
        const flashInterval = setInterval(() => {
            document.title = flashCount % 2 === 0 ? 'ðŸš¨ CRITICAL ALERT ðŸš¨' : originalTitle;
            flashCount++;
            if (flashCount >= 10) {
                clearInterval(flashInterval);
                document.title = originalTitle;
            }
        }, 1000);
    }
}

function emergencyRelease() {
    if (!currentTempleId) {
        alert('Please select a temple first');
        return;
    }
    
    if (confirm('Execute emergency release for all queues?')) {
        fetch(`/api/emergency-release/${currentTempleId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Emergency release activated for all queues');
                performAIAnalysis(); // Refresh data
            } else {
                alert('Emergency release failed: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Emergency release failed');
        });
    }
}

function optimizeAllQueues() {
    if (!currentTempleId) {
        alert('Please select a temple first');
        return;
    }
    
    fetch(`/api/optimize-queues/${currentTempleId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Auto-optimization applied successfully');
            performAIAnalysis(); // Refresh data
        } else {
            alert('Optimization failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Optimization failed');
    });
}

// Auto-refresh every 15 seconds when analysis is active
setInterval(() => {
    if (aiAnalysisInterval && currentTempleId) {
        performAIAnalysis();
    }
}, 15000);

function executeAction(queueName, actionType) {
    if (!currentTempleId) {
        alert('Please select a temple first');
        return;
    }
    
    if (confirm(`Execute ${actionType} for ${queueName} queue?`)) {
        fetch(`/api/execute-queue-action/${currentTempleId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                queue: queueName,
                action: actionType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Action executed: ${data.message}`);
                performAIAnalysis();
            } else {
                alert('Action failed: ' + data.error);
            }
        })
        .catch(error => {
            alert('Action execution failed');
        });
    }
}
</script>

<style>
.alert-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.progress {
    height: 8px;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.alert-danger {
    animation: pulse 2s infinite;
}
</style>
{% endblock %}