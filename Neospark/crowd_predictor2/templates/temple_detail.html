{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <img src="{{ temple.image_url or 'https://www.gujarattourism.com/content/dam/gujrattourism/images/religious-sites/somnath-temple/Somnath-Temple-Banner.jpg' }}" class="card-img-top" style="height: 400px; object-fit: cover; border-radius: 15px 15px 0 0;">
            <div class="card-body">
                <h2>{{ temple.name }}</h2>
                <p class="text-muted"><i class="bi bi-geo-alt"></i> {{ temple.location }}</p>
                <div class="alert alert-light border-start border-warning border-4 mb-4">
                    <p class="mb-0"><i class="bi bi-info-circle text-warning me-2"></i>{{ temple.description or 'A sacred temple for devotees to visit and seek blessings.' }}</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Temple Timings</h6>
                        <p>{{ temple.opening_time or '6:00 AM' }} - 
                           {{ temple.closing_time or '8:00 PM' }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Capacity</h6>
                        <p>{{ temple.capacity }} devotees</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <a href="{{ url_for('temple_guide', temple_id=temple.id) }}" class="btn btn-info btn-lg w-100">
                        <i class="bi bi-book"></i> Complete Temple Guide
                        <small class="d-block">First-time visitor? Get complete guidance</small>
                    </a>
                </div>
                
                <div class="mt-2">
                    <a href="{{ url_for('indian_guide') }}" class="btn btn-outline-primary w-100">
                        <i class="bi bi-map"></i> Indian Temple Navigation
                        <small class="d-block">Need step-by-step directions inside temple?</small>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5>Current Crowd Status</h5>
            </div>
            <div class="card-body text-center">
                {% if crowd %}
                    <h3 class="text-{{ 'success' if crowd.status == 'Low' else 'warning' if crowd.status == 'Medium' else 'danger' }}">
                        {{ crowd.status }}
                    </h3>
                    <p>{{ crowd.count }} people currently</p>
                {% else %}
                    <h3 class="text-success">Low</h3>
                    <p>0 people currently</p>
                {% endif %}
                <small class="text-muted">Last updated: {{ crowd.updated_at.strftime('%I:%M %p') if crowd else 'Just now' }}</small>
                {% if crowd and crowd.accuracy %}
                <div class="mt-2">
                    <small class="text-info">Detection Accuracy: {{ (crowd.accuracy * 100)|round }}%</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% include 'quick_guide_widget.html' %}
        
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h5>Book Darshan Slot</h5>
            </div>
            <div class="card-body">
                {% if current_user.is_authenticated %}
                    <form id="bookingForm">
                        <div class="mb-3">
                            <label class="form-label">Select Date</label>
                            <div id="calendar-widget">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="prevMonth">&lt;</button>
                                    <h6 id="monthYear" class="mb-0"></h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="nextMonth">&gt;</button>
                                </div>
                                <div class="calendar-grid" id="calendarGrid"></div>
                                <div class="mt-2">
                                    <small class="d-flex gap-2">
                                        <span><span class="badge" style="background-color: #28a745;">&nbsp;</span> Low</span>
                                        <span><span class="badge" style="background-color: #ffc107;">&nbsp;</span> Medium</span>
                                        <span><span class="badge" style="background-color: #dc3545;">&nbsp;</span> High</span>
                                    </small>
                                </div>
                            </div>
                            <input type="hidden" id="bookingDate" required>
                            <div id="selectedDateDisplay" class="mt-2" style="display: none;">
                                <small>Selected: <strong id="selectedDateText"></strong> - <span id="crowdBadge" class="badge"></span></small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Time Slot</label>
                            <select class="form-select" id="timeSlot" required>
                                <option value="">Select time slot</option>
                                <option value="06:00-08:00">6:00 AM - 8:00 AM</option>
                                <option value="08:00-10:00">8:00 AM - 10:00 AM</option>
                                <option value="10:00-12:00">10:00 AM - 12:00 PM</option>
                                <option value="12:00-14:00">12:00 PM - 2:00 PM</option>
                                <option value="14:00-16:00">2:00 PM - 4:00 PM</option>
                                <option value="16:00-18:00">4:00 PM - 6:00 PM</option>
                                <option value="18:00-20:00">6:00 PM - 8:00 PM</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Number of People</label>
                            <input type="number" class="form-control" id="persons" min="1" max="10" value="1" required>
                        </div>
                        
                        <!-- Prasad Selection -->
                        <div class="mb-3">
                            <label class="form-label">Select Prasad (Optional)</label>
                            {% if prasads %}
                                {% for prasad in prasads %}
                                <div class="form-check d-flex align-items-center mb-2">
                                    <input class="form-check-input prasad-item me-2" type="checkbox" value="{{ prasad.id }}" id="prasad{{ prasad.id }}" data-price="{{ prasad.price }}">
                                    <label class="form-check-label flex-grow-1" for="prasad{{ prasad.id }}">
                                        {{ prasad.name }} - ₹{{ prasad.price }}
                                    </label>
                                    <input type="number" class="form-control form-control-sm" style="width: 70px;" min="1" value="1" id="qty{{ prasad.id }}" disabled>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted small">No prasad available for this temple</p>
                            {% endif %}
                        </div>
                        
                        <!-- Pooja Selection -->
                        <div class="mb-3">
                            <label class="form-label">Select Special Pooja (Optional)</label>
                            {% if poojas %}
                                {% for pooja in poojas %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input pooja-item" type="checkbox" value="{{ pooja.id }}" id="pooja{{ pooja.id }}" data-price="{{ pooja.price }}">
                                    <label class="form-check-label" for="pooja{{ pooja.id }}">
                                        {{ pooja.name }} - ₹{{ pooja.price }} ({{ pooja.duration }} mins)
                                    </label>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted small">No special poojas available for this temple</p>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Total Amount (₹)</label>
                            <input type="number" class="form-control" id="amount" value="50" readonly>
                            <small class="text-muted">Darshan: ₹50 + Prasad & Pooja charges</small>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Book Darshan & Services</button>
                    </form>
                {% else %}
                    <div class="text-center">
                        <p>Please login to book darshan slots</p>
                        <a href="{{ url_for('login') }}" class="btn btn-primary">Login</a>
                        <a href="{{ url_for('register') }}" class="btn btn-outline-primary">Register</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 24px);
    gap: 1px;
    margin-bottom: 8px;
    justify-content: center;
}

.calendar-day {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    cursor: pointer;
    font-size: 10px;
    font-weight: 500;
    color: #333;
    background-color: #fff;
    position: relative;
    transition: all 0.2s;
}

.calendar-day::after {
    content: '';
    position: absolute;
    top: 1px;
    right: 1px;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background-color: var(--after-bg, transparent);
}

.calendar-day:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.calendar-day.selected {
    border: 2px solid #007bff;
    transform: scale(1.1);
}

.calendar-day.disabled {
    background-color: #f8f9fa !important;
    color: #6c757d !important;
    cursor: not-allowed;
}

.calendar-day.disabled:hover {
    transform: none;
    box-shadow: none;
}

.calendar-header {
    width: 24px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    text-align: center;
    font-size: 9px;
    color: #666;
    background-color: #f8f9fa;
}
</style>

<script>
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let selectedDate = null;

const monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"];
const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

function generateCalendar(month, year) {
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;
    
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';
    
    // Add header days
    dayNames.forEach(day => {
        const dayDiv = document.createElement('div');
        dayDiv.textContent = day;
        dayDiv.className = 'calendar-header';
        calendarGrid.appendChild(dayDiv);
    });
    
    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'calendar-day disabled';
        calendarGrid.appendChild(emptyDiv);
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isPast = date < today;
        
        if (isPast) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day disabled';
            dayElement.textContent = day;
            calendarGrid.appendChild(dayElement);
        } else {
            getCrowdPredictionForDay(dateStr, day);
        }
    }
}

function getCrowdPredictionForDay(dateStr, day) {
    fetch(`/api/available-slots?temple_id={{ temple.id }}&date=${dateStr}`)
        .then(response => response.json())
        .then(data => {
            const crowdLevel = data.predicted_crowd || 'low';
            const color = getCrowdColor(crowdLevel);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            dayElement.dataset.date = dateStr;
            dayElement.dataset.crowd = crowdLevel;
            
            // Set dot color using CSS custom property
            dayElement.style.setProperty('--dot-color', color);
            dayElement.style.setProperty('--after-bg', color);
            
            dayElement.addEventListener('click', function() {
                selectCalendarDate(dateStr, crowdLevel, this);
            });
            
            document.getElementById('calendarGrid').appendChild(dayElement);
        })
        .catch(() => {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            dayElement.dataset.date = dateStr;
            dayElement.dataset.crowd = 'low';
            dayElement.style.setProperty('--after-bg', '#6c757d');
            
            dayElement.addEventListener('click', function() {
                selectCalendarDate(dateStr, 'low', this);
            });
            
            document.getElementById('calendarGrid').appendChild(dayElement);
        });
}

function getCrowdColor(crowdLevel) {
    const colors = {
        'low': '#28a745',
        'medium': '#ffc107', 
        'high': '#dc3545'
    };
    return colors[crowdLevel] || '#6c757d';
}

function selectCalendarDate(dateStr, crowdLevel, element) {
    document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
    });
    
    element.classList.add('selected');
    
    selectedDate = dateStr;
    document.getElementById('bookingDate').value = dateStr;
    document.getElementById('selectedDateText').textContent = new Date(dateStr).toLocaleDateString();
    document.getElementById('crowdBadge').textContent = crowdLevel.charAt(0).toUpperCase() + crowdLevel.slice(1);
    document.getElementById('crowdBadge').className = `badge bg-${crowdLevel === 'low' ? 'success' : crowdLevel === 'medium' ? 'warning' : 'danger'}`;
    document.getElementById('selectedDateDisplay').style.display = 'block';
}

document.getElementById('prevMonth').addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    generateCalendar(currentMonth, currentYear);
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    generateCalendar(currentMonth, currentYear);
});

// Update amount calculation
function updateTotalAmount() {
    const persons = parseInt(document.getElementById('persons').value) || 1;
    let total = persons * 50;
    
    document.querySelectorAll('.prasad-item:checked').forEach(checkbox => {
        const price = parseFloat(checkbox.dataset.price);
        const qty = parseInt(document.getElementById('qty' + checkbox.value).value) || 1;
        total += price * qty;
    });
    
    document.querySelectorAll('.pooja-item:checked').forEach(checkbox => {
        const price = parseFloat(checkbox.dataset.price);
        total += price;
    });
    
    document.getElementById('amount').value = total;
}

document.getElementById('persons').addEventListener('input', updateTotalAmount);

function initializePrasadListeners() {
    document.querySelectorAll('.prasad-item').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const qtyInput = document.getElementById('qty' + this.value);
            if (qtyInput) {
                qtyInput.disabled = !this.checked;
                if (!this.checked) qtyInput.value = 1;
            }
            updateTotalAmount();
        });
    });
    
    document.querySelectorAll('[id^="qty"]').forEach(input => {
        input.addEventListener('input', updateTotalAmount);
    });
}

function initializePoojaListeners() {
    document.querySelectorAll('.pooja-item').forEach(checkbox => {
        checkbox.addEventListener('change', updateTotalAmount);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initializePrasadListeners();
    initializePoojaListeners();
    updateTotalAmount();
    generateCalendar(currentMonth, currentYear);
});

document.getElementById('bookingForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate required fields
    if (!selectedDate) {
        alert('Please select a date for your visit.');
        return;
    }
    
    if (!document.getElementById('timeSlot').value) {
        alert('Please select a time slot.');
        return;
    }
    
    const prasads = [];
    document.querySelectorAll('.prasad-item:checked').forEach(checkbox => {
        prasads.push({
            id: parseInt(checkbox.value),
            quantity: parseInt(document.getElementById('qty' + checkbox.value).value) || 1
        });
    });
    
    const poojas = [];
    document.querySelectorAll('.pooja-item:checked').forEach(checkbox => {
        poojas.push({
            id: parseInt(checkbox.value)
        });
    });
    
    const formData = {
        temple_id: {{ temple.id }},
        date: document.getElementById('bookingDate').value,
        time_slot: document.getElementById('timeSlot').value,
        persons: parseInt(document.getElementById('persons').value),
        prasads: prasads,
        poojas: poojas
    };
    
    fetch('/api/book', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Booking Created!\n\nBooking ID: ${data.booking_id}\nTotal Amount: ₹${data.total_amount}\n\nRedirecting to payment...`);
            window.location.href = `/payment/${data.booking_id}`;
        } else {
            alert(`Booking failed: ${data.error || 'Please try again.'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
});
</script>

{% endblock %}