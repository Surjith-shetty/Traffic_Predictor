{% extends "base.html" %}

{% block title %}Queue Analytics Dashboard - Temple Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-graph-up-arrow"></i> Queue Analytics Dashboard</h2>
        <p class="text-muted">Advanced queue performance metrics and optimization insights</p>
    </div>
</div>

<!-- Real-time Queue Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="bi bi-people fs-1"></i>
                <h4 id="totalPeopleMetric">0</h4>
                <p class="mb-0">Total in Queues</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <i class="bi bi-clock fs-1"></i>
                <h4 id="avgWaitTimeMetric">0</h4>
                <p class="mb-0">Avg Wait (min)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle fs-1"></i>
                <h4 id="bottlenecksMetric">0</h4>
                <p class="mb-0">Active Bottlenecks</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="bi bi-speedometer2 fs-1"></i>
                <h4 id="throughputMetric">0</h4>
                <p class="mb-0">People/Hour</p>
            </div>
        </div>
    </div>
</div>

<!-- Queue Flow Heatmap -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-thermometer-half"></i> Queue Flow Heatmap</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="queueHeatmap" width="600" height="400"></canvas>
                    </div>
                    <div class="col-md-4">
                        <h6>Heat Legend</h6>
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-success" style="width: 20px; height: 20px; margin-right: 10px;"></div>
                            <span>Low Density (0-10 people)</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-warning" style="width: 20px; height: 20px; margin-right: 10px;"></div>
                            <span>Medium Density (11-25 people)</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-danger" style="width: 20px; height: 20px; margin-right: 10px;"></div>
                            <span>High Density (26+ people)</span>
                        </div>
                        
                        <hr>
                        <h6>Queue Efficiency</h6>
                        <div id="queueEfficiency">
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success" id="entryEfficiency" style="width: 0%"></div>
                            </div>
                            <small>Entry Queue: <span id="entryEfficiencyText">0%</span></small>
                            
                            <div class="progress mb-2 mt-2">
                                <div class="progress-bar bg-info" id="darshanEfficiency" style="width: 0%"></div>
                            </div>
                            <small>Darshan Queue: <span id="darshanEfficiencyText">0%</span></small>
                            
                            <div class="progress mb-2 mt-2">
                                <div class="progress-bar bg-warning" id="prasadEfficiency" style="width: 0%"></div>
                            </div>
                            <small>Prasad Queue: <span id="prasadEfficiencyText">0%</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Queue Performance Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header">
                <h5><i class="bi bi-graph-up"></i> Queue Length Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="queueTrendsChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header">
                <h5><i class="bi bi-pie-chart"></i> Queue Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="queueDistributionChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Wait Time Analysis -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> Wait Time Analysis</h5>
            </div>
            <div class="card-body">
                <canvas id="waitTimeChart" height="150"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header">
                <h5><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="optimizeQueues()">
                        <i class="bi bi-gear"></i> Auto-Optimize
                    </button>
                    <button class="btn btn-warning" onclick="redistributeQueues()">
                        <i class="bi bi-shuffle"></i> Redistribute
                    </button>
                    <button class="btn btn-info" onclick="exportAnalytics()">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                    <button class="btn btn-success" onclick="generateReport()">
                        <i class="bi bi-file-text"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optimization Recommendations -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h5><i class="bi bi-robot"></i> AI-Powered Recommendations</h5>
            </div>
            <div class="card-body">
                <div id="aiRecommendations">
                    <div class="text-center text-muted">
                        <i class="bi bi-cpu fs-1"></i>
                        <p>Analyzing queue patterns to generate recommendations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Temple Selection Modal -->
<div class="modal fade" id="templeSelectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Temple for Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <select class="form-select" id="analyticsTempleSelect">
                    <option value="">Choose temple...</option>
                    {% for temple in temples %}
                    <option value="{{ temple.id }}">{{ temple.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="loadTempleAnalytics()">Load Analytics</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentTempleId = null;
let analyticsData = null;
let charts = {};

// Initialize analytics on page load
document.addEventListener('DOMContentLoaded', function() {
    // Show temple selection modal
    new bootstrap.Modal(document.getElementById('templeSelectModal')).show();
    
    // Initialize empty charts
    initializeCharts();
    
    // Start real-time updates
    setInterval(updateRealTimeMetrics, 10000);
});

function loadTempleAnalytics() {
    const templeId = document.getElementById('analyticsTempleSelect').value;
    if (!templeId) {
        alert('Please select a temple');
        return;
    }
    
    currentTempleId = templeId;
    bootstrap.Modal.getInstance(document.getElementById('templeSelectModal')).hide();
    
    // Load analytics data
    fetchAnalyticsData();
}

function fetchAnalyticsData() {
    if (!currentTempleId) return;
    
    fetch(`/api/queue-analytics/${currentTempleId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            analyticsData = data.analytics;
            updateDashboard();
        } else {
            console.error('Failed to load analytics:', data.error);
        }
    })
    .catch(error => console.error('Error fetching analytics:', error));
}

function updateDashboard() {
    if (!analyticsData) return;
    
    // Update metrics
    updateMetrics();
    
    // Update charts
    updateCharts();
    
    // Update heatmap
    updateHeatmap();
    
    // Update recommendations
    updateRecommendations();
}

function updateMetrics() {
    const metrics = analyticsData.metrics;
    
    document.getElementById('totalPeopleMetric').textContent = metrics.total_people || 0;
    document.getElementById('avgWaitTimeMetric').textContent = Math.round(metrics.avg_wait_time || 0);
    document.getElementById('bottlenecksMetric').textContent = metrics.bottlenecks || 0;
    document.getElementById('throughputMetric').textContent = Math.round(metrics.throughput || 0);
    
    // Update efficiency bars
    const efficiency = metrics.efficiency || {};
    updateEfficiencyBar('entry', efficiency.entry || 0);
    updateEfficiencyBar('darshan', efficiency.darshan || 0);
    updateEfficiencyBar('prasad', efficiency.prasad || 0);
}

function updateEfficiencyBar(queueType, efficiency) {
    const bar = document.getElementById(`${queueType}Efficiency`);
    const text = document.getElementById(`${queueType}EfficiencyText`);
    
    bar.style.width = `${efficiency}%`;
    text.textContent = `${Math.round(efficiency)}%`;
    
    // Update color based on efficiency
    bar.className = `progress-bar ${efficiency >= 80 ? 'bg-success' : efficiency >= 60 ? 'bg-warning' : 'bg-danger'}`;
}

function initializeCharts() {
    // Queue Trends Chart
    const trendsCtx = document.getElementById('queueTrendsChart').getContext('2d');
    charts.trends = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Entry Queue',
                    data: [],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Darshan Queue',
                    data: [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Prasad Queue',
                    data: [],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'People Count'
                    }
                }
            }
        }
    });
    
    // Queue Distribution Chart
    const distributionCtx = document.getElementById('queueDistributionChart').getContext('2d');
    charts.distribution = new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Entry', 'Darshan', 'Prasad', 'Exit'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Wait Time Chart
    const waitTimeCtx = document.getElementById('waitTimeChart').getContext('2d');
    charts.waitTime = new Chart(waitTimeCtx, {
        type: 'bar',
        data: {
            labels: ['Entry', 'Darshan', 'Prasad'],
            datasets: [{
                label: 'Wait Time (minutes)',
                data: [0, 0, 0],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Minutes'
                    }
                }
            }
        }
    });
}

function updateCharts() {
    if (!analyticsData) return;
    
    const queueData = analyticsData.queue_data || {};
    const trends = analyticsData.trends || [];
    
    // Update trends chart
    if (trends.length > 0) {
        charts.trends.data.labels = trends.map(t => new Date(t.timestamp).toLocaleTimeString());
        charts.trends.data.datasets[0].data = trends.map(t => t.entry || 0);
        charts.trends.data.datasets[1].data = trends.map(t => t.darshan || 0);
        charts.trends.data.datasets[2].data = trends.map(t => t.prasad || 0);
        charts.trends.update();
    }
    
    // Update distribution chart
    const currentCounts = [
        queueData.entry?.count || 0,
        queueData.darshan?.count || 0,
        queueData.prasad?.count || 0,
        queueData.exit?.count || 0
    ];
    charts.distribution.data.datasets[0].data = currentCounts;
    charts.distribution.update();
    
    // Update wait time chart
    const waitTimes = [
        queueData.entry?.wait_time || 0,
        queueData.darshan?.wait_time || 0,
        queueData.prasad?.wait_time || 0
    ];
    charts.waitTime.data.datasets[0].data = waitTimes;
    charts.waitTime.update();
}

function updateHeatmap() {
    const canvas = document.getElementById('queueHeatmap');
    const ctx = canvas.getContext('2d');
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!analyticsData || !analyticsData.queue_data) return;
    
    const queueData = analyticsData.queue_data;
    
    // Draw queue zones with heat colors
    const zones = [
        { name: 'Entry', x: 50, y: 50, width: 120, height: 300, count: queueData.entry?.count || 0 },
        { name: 'Darshan', x: 200, y: 50, width: 120, height: 300, count: queueData.darshan?.count || 0 },
        { name: 'Prasad', x: 350, y: 50, width: 120, height: 150, count: queueData.prasad?.count || 0 },
        { name: 'Exit', x: 350, y: 220, width: 120, height: 130, count: queueData.exit?.count || 0 }
    ];
    
    zones.forEach(zone => {
        // Determine heat color
        let color;
        if (zone.count <= 10) {
            color = '#28a745'; // Green
        } else if (zone.count <= 25) {
            color = '#ffc107'; // Yellow
        } else {
            color = '#dc3545'; // Red
        }
        
        // Draw zone
        ctx.fillStyle = color;
        ctx.fillRect(zone.x, zone.y, zone.width, zone.height);
        
        // Draw border
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.strokeRect(zone.x, zone.y, zone.width, zone.height);
        
        // Draw label
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(zone.name, zone.x + zone.width/2, zone.y + 20);
        ctx.fillText(`${zone.count} people`, zone.x + zone.width/2, zone.y + 40);
    });
    
    // Draw flow arrows
    ctx.strokeStyle = '#007bff';
    ctx.lineWidth = 3;
    drawArrow(ctx, 170, 200, 200, 200);
    drawArrow(ctx, 320, 200, 350, 200);
    drawArrow(ctx, 410, 200, 410, 220);
}

function drawArrow(ctx, fromX, fromY, toX, toY) {
    const headlen = 10;
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);
    
    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function updateRecommendations() {
    if (!analyticsData || !analyticsData.recommendations) return;
    
    const recommendations = analyticsData.recommendations;
    let html = '';
    
    recommendations.forEach(rec => {
        const iconClass = rec.priority === 'high' ? 'bi-exclamation-triangle text-danger' : 
                         rec.priority === 'medium' ? 'bi-info-circle text-warning' : 'bi-lightbulb text-info';
        
        html += `
            <div class="alert alert-light border-start border-4 border-${rec.priority === 'high' ? 'danger' : rec.priority === 'medium' ? 'warning' : 'info'} mb-2">
                <div class="d-flex align-items-center">
                    <i class="bi ${iconClass} fs-4 me-3"></i>
                    <div>
                        <h6 class="mb-1">${rec.type.replace('_', ' ').toUpperCase()}</h6>
                        <p class="mb-0">${rec.suggestion}</p>
                        <small class="text-muted">Location: ${rec.location}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('aiRecommendations').innerHTML = html || '<p class="text-muted">No recommendations at this time.</p>';
}

function updateRealTimeMetrics() {
    if (currentTempleId) {
        fetchAnalyticsData();
    }
}

function optimizeQueues() {
    if (!currentTempleId) return;
    
    fetch(`/api/queue-optimization/${currentTempleId}`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Queue optimization applied successfully!');
            fetchAnalyticsData();
        } else {
            alert('Optimization failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Optimization failed');
    });
}

function redistributeQueues() {
    alert('Queue redistribution feature coming soon!');
}

function exportAnalytics() {
    if (!analyticsData) return;
    
    const dataStr = JSON.stringify(analyticsData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `queue_analytics_${currentTempleId}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

function generateReport() {
    if (!currentTempleId) return;
    
    window.open(`/api/queue-report/${currentTempleId}`, '_blank');
}
</script>

<style>
.border-start {
    border-left: 4px solid !important;
}

#queueHeatmap {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.progress {
    height: 8px;
}
</style>
{% endblock %}