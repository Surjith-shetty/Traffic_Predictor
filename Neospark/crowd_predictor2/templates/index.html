{% extends "base.html" %}

{% block content %}
<!-- Hero Section with Background -->
<div class="hero-section position-relative overflow-hidden mb-5" style="height: 80vh; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1582510003544-4d00b7f74220?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80') center/cover; color: white;">
    <div class="container h-100 d-flex align-items-center">
        <div class="row w-100">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-2 fw-bold mb-4">üïâÔ∏è Divine Darshan</h1>
                <p class="lead fs-3 mb-5">Smart Temple Management & Pilgrimage Experience</p>
                <p class="fs-5 mb-5 opacity-75">AI-powered crowd management ‚Ä¢ Real-time booking ‚Ä¢ Digital prasadam</p>
                
                <div class="d-flex flex-wrap justify-content-center gap-3 mb-5">
                    <a href="{{ url_for('temples') }}" class="btn btn-warning btn-lg px-5 py-3 rounded-pill shadow-lg">
                        <i class="bi bi-geo-alt me-2"></i>Explore Sacred Temples
                    </a>
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('my_bookings') }}" class="btn btn-outline-light btn-lg px-5 py-3 rounded-pill">
                            <i class="bi bi-calendar-check me-2"></i>My Bookings
                        </a>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="btn btn-outline-light btn-lg px-5 py-3 rounded-pill">
                            <i class="bi bi-person me-2"></i>Join Now
                        </a>
                    {% endif %}
                </div>
                
                <!-- Live Stats -->
                <div class="row g-4 mt-4">
                    <div class="col-md-4">
                        <div class="bg-white bg-opacity-10 rounded-4 p-4">
                            <h3 class="fw-bold text-warning">{{ temples|length }}</h3>
                            <p class="mb-0">Sacred Temples</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-white bg-opacity-10 rounded-4 p-4">
                            <h3 class="fw-bold text-success">AI Powered</h3>
                            <p class="mb-0">Crowd Detection</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-white bg-opacity-10 rounded-4 p-4">
                            <h3 class="fw-bold text-info">24/7</h3>
                            <p class="mb-0">Live Monitoring</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Temple Selection & Map -->
{% if temples %}
<div class="row mb-5">
    <div class="col-12">
        <h2 class="text-center mb-4">Temple Location & Crowd Status</h2>
    </div>
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Select Temple</h6>
            </div>
            <div class="card-body">
                <select class="form-select mb-3" id="templeSelect">
                    <option value="">Choose a temple...</option>
                    {% for temple in temples %}
                    <option value="{{ temple.id }}">{{ temple.name }}</option>
                    {% endfor %}
                </select>
                <div id="templeInfo" class="d-none">
                    <h6 id="templeName"></h6>
                    <p id="templeLocation" class="text-muted small"></p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Crowd Status:</span>
                        <span id="crowdBadge" class="badge">-</span>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">People Count: <span id="crowdCount">-</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">Temple Location</h6>
            </div>
            <div class="card-body p-0">
                <div id="templeMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Featured Temples -->
<div class="container-fluid bg-light py-5 mb-5">
    <div class="container">
        <div class="row mb-5">
            <div class="col-12 text-center">
                <h2 class="display-5 fw-bold mb-3">Sacred Temples of Karnataka</h2>
                <p class="lead text-muted">Experience divine darshan with smart crowd management</p>
            </div>
        </div>
        <div class="row g-4">
            {% for temple in temples %}
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-lg h-100 temple-card overflow-hidden">
                    <div class="position-relative">
                        <img src="{{ temple.image_url or 'https://www.gujarattourism.com/content/dam/gujrattourism/images/religious-sites/somnath-temple/Somnath-Temple-Banner.jpg' }}" class="card-img-top" style="height: 250px; object-fit: cover;">
                        <div class="position-absolute top-0 end-0 m-3">
                            <span class="badge bg-success crowd-status px-3 py-2 rounded-pill" data-temple-id="{{ temple.id }}">Loading...</span>
                        </div>
                        <div class="position-absolute bottom-0 start-0 end-0 bg-gradient-dark p-3">
                            <h5 class="text-white mb-1">{{ temple.name }}</h5>
                            <p class="text-white-50 mb-0 small"><i class="bi bi-geo-alt me-1"></i>{{ temple.location }}</p>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-muted small mb-3">{{ temple.description[:80] }}...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">
                                <i class="bi bi-people me-1"></i>Capacity: {{ temple.capacity }}
                            </div>
                            <a href="{{ url_for('temple_detail', temple_id=temple.id) }}" class="btn btn-primary btn-sm rounded-pill px-3">
                                Book Now <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Features Section -->
<div class="container py-5 mb-5">
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h2 class="display-5 fw-bold mb-3">Revolutionary Features</h2>
            <p class="lead text-muted">Technology meets spirituality for seamless pilgrimage</p>
        </div>
    </div>
    <div class="row g-4">
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-lg h-100 feature-card">
                <div class="card-body text-center p-5">
                    <div class="feature-icon bg-primary bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                        <i class="bi bi-robot fs-2 text-white"></i>
                    </div>
                    <h4 class="fw-bold mb-3">AI Crowd Detection</h4>
                    <p class="text-muted">Real-time people counting with green bounding boxes and 95% accuracy using YOLOv8</p>
                    <div class="mt-4">
                        <span class="badge bg-primary bg-opacity-10 text-primary me-2">Computer Vision</span>
                        <span class="badge bg-success bg-opacity-10 text-success">Real-time</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-lg h-100 feature-card">
                <div class="card-body text-center p-5">
                    <div class="feature-icon bg-success bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                        <i class="bi bi-calendar-check fs-2 text-white"></i>
                    </div>
                    <h4 class="fw-bold mb-3">Smart Booking</h4>
                    <p class="text-muted">QR code based entry system with email confirmations and digital prasadam ordering</p>
                    <div class="mt-4">
                        <span class="badge bg-success bg-opacity-10 text-success me-2">QR Codes</span>
                        <span class="badge bg-info bg-opacity-10 text-info">Digital</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-lg h-100 feature-card">
                <div class="card-body text-center p-5">
                    <div class="feature-icon bg-warning bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                        <i class="bi bi-bell fs-2 text-white"></i>
                    </div>
                    <h4 class="fw-bold mb-3">Alert System</h4>
                    <p class="text-muted">Automatic email alerts to pilgrims when temples reach high crowd capacity</p>
                    <div class="mt-4">
                        <span class="badge bg-warning bg-opacity-10 text-warning me-2">Email Alerts</span>
                        <span class="badge bg-danger bg-opacity-10 text-danger">Safety</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chatbot -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
    <button class="btn btn-primary rounded-circle shadow-lg animate-bounce" id="chatbotToggle" style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
        <i class="bi bi-robot fs-4"></i>
    </button>
</div>

<div class="position-fixed bottom-0 end-0 p-3" id="chatbotWindow" style="display: none; z-index: 1001;">
    <div class="card shadow-lg" style="width: 350px; height: 500px; border-radius: 15px; overflow: hidden;">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">ü§ñ Divine Darshan AI</h6>
                    <small class="opacity-75">Your booking assistant</small>
                </div>
                <button class="btn btn-sm btn-outline-light" onclick="document.getElementById('chatbotWindow').style.display='none'">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        <div class="card-body d-flex flex-column p-0">
            <div id="chatMessages" class="flex-grow-1 overflow-auto p-3" style="background: #f8f9fa; max-height: 350px; overflow-y: auto;">
                <div class="mb-2">
                    <span class="badge bg-secondary px-3 py-2">üôè Namaste! I'll help you book temple visits step by step.</span>
                </div>
                <div class="mb-2">
                    <span class="badge bg-info px-3 py-2">üìù Say "Book temple" to start!</span>
                </div>
                <div class="quick-replies mb-2">
                    <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="sendQuickReply('Book temple')">üìÖ Book Temple</button>
                    <button class="btn btn-outline-secondary btn-sm me-1 mb-1" onclick="sendQuickReply('Help')">‚ùì Help</button>
                </div>
            </div>
            <div class="p-3 bg-white border-top">
                <div class="input-group">
                    <input type="text" class="form-control border-0 bg-light" id="chatInput" placeholder="Type your message..." maxlength="200">
                    <button class="btn btn-primary" id="chatSend" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map, currentMarker, crowdCircle;
let templeData = {};

// Load temple data from API
fetch('/api/temples')
    .then(response => response.json())
    .then(temples => {
        temples.forEach(temple => {
            templeData[temple.id] = {
                name: temple.name,
                location: temple.location,
                lat: temple.latitude || 22.5,
                lng: temple.longitude || 71.5,
                crowd: { status: 'Low', count: 0 }
            };
        });
    });

// Initialize map
function initMap() {
    map = L.map('templeMap').setView([22.5, 71.5], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
}

// Update map with selected temple
function updateMap(templeId) {
    const temple = templeData[templeId];
    if (!temple) return;
    
    // Remove existing markers
    if (currentMarker) map.removeLayer(currentMarker);
    if (crowdCircle) map.removeLayer(crowdCircle);
    
    // Add temple marker
    currentMarker = L.marker([temple.lat, temple.lng])
        .addTo(map)
        .bindPopup(`<b>${temple.name}</b><br>${temple.location}<br>Crowd: ${temple.crowd.status}`);
    
    // Add crowd density circle
    const crowdColor = temple.crowd.status === 'Low' ? 'green' : 
                      temple.crowd.status === 'Medium' ? 'orange' : 'red';
    
    crowdCircle = L.circle([temple.lat, temple.lng], {
        color: crowdColor,
        fillColor: crowdColor,
        fillOpacity: 0.3,
        radius: temple.crowd.count * 50 + 1000
    }).addTo(map);
    
    // Center map on temple
    map.setView([temple.lat, temple.lng], 12);
    
    // Update temple info
    document.getElementById('templeName').textContent = temple.name;
    document.getElementById('templeLocation').textContent = temple.location;
    document.getElementById('crowdBadge').textContent = temple.crowd.status;
    document.getElementById('crowdBadge').className = `badge bg-${temple.crowd.status === 'Low' ? 'success' : temple.crowd.status === 'Medium' ? 'warning' : 'danger'}`;
    document.getElementById('crowdCount').textContent = temple.crowd.count;
    document.getElementById('templeInfo').classList.remove('d-none');
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('templeMap')) {
        initMap();
        
        document.getElementById('templeSelect')?.addEventListener('change', function() {
            const selectedTemple = this.value;
            if (selectedTemple) {
                updateMap(selectedTemple);
            } else {
                document.getElementById('templeInfo').classList.add('d-none');
                if (currentMarker) map.removeLayer(currentMarker);
                if (crowdCircle) map.removeLayer(crowdCircle);
                map.setView([22.5, 71.5], 7);
            }
        });
    }
    
    // Load crowd status for featured temples
    document.querySelectorAll('.crowd-status').forEach(badge => {
        const templeId = badge.dataset.templeId;
        fetch(`/api/temple/${templeId}/crowd`)
            .then(response => response.json())
            .then(data => {
                badge.textContent = data.status;
                badge.className = `badge bg-${data.status === 'Low' ? 'success' : data.status === 'Medium' ? 'warning' : 'danger'}`;
                if (templeData[templeId]) {
                    templeData[templeId].crowd = data;
                }
            })
            .catch(() => {
                const dummyStatus = ['Low', 'Medium', 'High'][Math.floor(Math.random() * 3)];
                badge.textContent = dummyStatus;
                badge.className = `badge bg-${dummyStatus === 'Low' ? 'success' : dummyStatus === 'Medium' ? 'warning' : 'danger'}`;
            });
    });
    
    // Chatbot functionality
    document.getElementById('chatbotToggle')?.addEventListener('click', function() {
        const window = document.getElementById('chatbotWindow');
        window.style.display = window.style.display === 'none' ? 'block' : 'none';
    });
    
    document.getElementById('chatSend')?.addEventListener('click', sendMessage);
    document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });
});

let chatState = { step: 'greeting', bookingData: {} };

function sendMessage() {
    const input = document.getElementById('chatInput');
    const messages = document.getElementById('chatMessages');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    messages.innerHTML += `<div class="text-end mb-2"><span class="badge bg-primary px-3 py-2">${message}</span></div>`;
    input.value = '';
    
    // Show typing indicator
    messages.innerHTML += `<div class="mb-2 typing-indicator"><span class="badge bg-light text-dark px-3 py-2">ü§ñ Processing...</span></div>`;
    messages.scrollTop = messages.scrollHeight;
    
    setTimeout(() => {
        document.querySelector('.typing-indicator')?.remove();
        processMessage(message.toLowerCase(), messages);
        messages.scrollTop = messages.scrollHeight;
    }, 800);
}

function processMessage(message, messages) {
    if (chatState.step === 'greeting') {
        if (message.includes('book') || message.includes('ticket') || message.includes('darshan')) {
            chatState.step = 'temple';
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-success px-3 py-2">üèõÔ∏è Which temple would you like to book?</span></div>`;
            addTempleButtons(messages);
        } else if (message.includes('crowd') || message.includes('status')) {
            handleCrowdQuery(messages);
        } else if (message.includes('help')) {
            showHelp(messages);
        } else {
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-secondary px-3 py-2">üôè I can help you book temples! Say "Book temple" to start.</span></div>`;
            messages.innerHTML += `<div class="quick-replies mb-2">
                <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="sendQuickReply('Book temple')">üìÖ Book Temple</button>
            </div>`;
        }
    } else if (chatState.step === 'temple') {
        const templeId = extractTemple(message);
        if (templeId) {
            chatState.bookingData.temple_id = templeId;
            chatState.step = 'date';
            const templeName = getTempleName(templeId);
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-success px-3 py-2">‚úÖ ${templeName} selected. What date?</span></div>`;
            addDateButtons(messages);
        } else {
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-warning px-3 py-2">Please select a temple:</span></div>`;
            addTempleButtons(messages);
        }
    } else if (chatState.step === 'date') {
        const date = extractDate(message);
        if (date) {
            chatState.bookingData.date = date;
            chatState.step = 'time';
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-success px-3 py-2">‚úÖ Date: ${new Date(date).toDateString()}. What time?</span></div>`;
            addTimeButtons(messages);
        } else {
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-warning px-3 py-2">Please choose a date:</span></div>`;
            addDateButtons(messages);
        }
    } else if (chatState.step === 'time') {
        const timeSlot = extractTime(message);
        if (timeSlot) {
            chatState.bookingData.time_slot = timeSlot;
            chatState.step = 'people';
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-success px-3 py-2">‚úÖ Time: ${timeSlot}. How many people?</span></div>`;
            addPeopleButtons(messages);
        } else {
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-warning px-3 py-2">Please choose a time:</span></div>`;
            addTimeButtons(messages);
        }
    } else if (chatState.step === 'people') {
        const people = extractPeople(message);
        if (people) {
            chatState.bookingData.persons = people;
            createBooking(messages);
        } else {
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-warning px-3 py-2">How many people? (1-10)</span></div>`;
            addPeopleButtons(messages);
        }
    }
}

function extractTemple(message) {
    const temples = {
        'udupi': 3, 'krishna': 3,
        'hampi': 1, 'virupaksha': 1,
        'murudeshwara': 2, 'murdeshwar': 2,
        'belur': 4, 'chennakeshava': 4
    };
    
    for (const [key, id] of Object.entries(temples)) {
        if (message.includes(key)) return id;
    }
    return null;
}

function getTempleName(id) {
    const names = {
        1: 'Virupaksha Temple, Hampi',
        2: 'Murudeshwara Temple',
        3: 'Sri Krishna Temple, Udupi',
        4: 'Chennakeshava Temple, Belur'
    };
    return names[id] || 'Temple';
}

function extractDate(message) {
    const today = new Date();
    if (message.includes('tomorrow')) {
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        return tomorrow.toISOString().split('T')[0];
    }
    if (message.includes('sunday')) {
        const sunday = new Date(today);
        sunday.setDate(today.getDate() + (7 - today.getDay()));
        return sunday.toISOString().split('T')[0];
    }
    if (message.includes('monday')) {
        const monday = new Date(today);
        monday.setDate(today.getDate() + (1 - today.getDay() + 7) % 7);
        return monday.toISOString().split('T')[0];
    }
    return null;
}

function extractTime(message) {
    if (message.includes('morning') || message.includes('6') || message.includes('7') || message.includes('8')) return '06:00-08:00';
    if (message.includes('afternoon') || message.includes('12') || message.includes('1') || message.includes('2')) return '12:00-14:00';
    if (message.includes('evening') || message.includes('6') || message.includes('7') || message.includes('8')) return '18:00-20:00';
    return null;
}

function extractPeople(message) {
    const match = message.match(/(\d+)/i);
    if (match) {
        const num = parseInt(match[1]);
        return (num >= 1 && num <= 10) ? num : null;
    }
    return null;
}

function addTempleButtons(messages) {
    messages.innerHTML += `<div class="quick-replies mb-2">
        <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="sendQuickReply('Udupi Krishna temple')">Udupi Krishna</button>
        <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="sendQuickReply('Hampi Virupaksha temple')">Hampi Virupaksha</button>
        <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="sendQuickReply('Murudeshwara temple')">Murudeshwara</button>
        <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="sendQuickReply('Belur Chennakeshava temple')">Belur Chennakeshava</button>
    </div>`;
}

function addDateButtons(messages) {
    messages.innerHTML += `<div class="quick-replies mb-2">
        <button class="btn btn-outline-success btn-sm me-1 mb-1" onclick="sendQuickReply('Tomorrow')">Tomorrow</button>
        <button class="btn btn-outline-success btn-sm me-1 mb-1" onclick="sendQuickReply('Sunday')">Sunday</button>
        <button class="btn btn-outline-success btn-sm me-1 mb-1" onclick="sendQuickReply('Monday')">Monday</button>
    </div>`;
}

function addTimeButtons(messages) {
    messages.innerHTML += `<div class="quick-replies mb-2">
        <button class="btn btn-outline-info btn-sm me-1 mb-1" onclick="sendQuickReply('Morning')">Morning (6-8 AM)</button>
        <button class="btn btn-outline-info btn-sm me-1 mb-1" onclick="sendQuickReply('Afternoon')">Afternoon (12-2 PM)</button>
        <button class="btn btn-outline-info btn-sm me-1 mb-1" onclick="sendQuickReply('Evening')">Evening (6-8 PM)</button>
    </div>`;
}

function addPeopleButtons(messages) {
    messages.innerHTML += `<div class="quick-replies mb-2">
        <button class="btn btn-outline-warning btn-sm me-1 mb-1" onclick="sendQuickReply('1 person')">1 Person</button>
        <button class="btn btn-outline-warning btn-sm me-1 mb-1" onclick="sendQuickReply('2 people')">2 People</button>
        <button class="btn btn-outline-warning btn-sm me-1 mb-1" onclick="sendQuickReply('4 people')">4 People</button>
    </div>`;
}

function showBookingSummary(messages) {
    const templeName = getTempleName(chatState.bookingData.temple_id);
    const date = new Date(chatState.bookingData.date).toDateString();
    const amount = chatState.bookingData.persons * 50;
    
    messages.innerHTML += `<div class="mb-2"><span class="badge bg-info px-3 py-2">üìã <strong>Booking Summary:</strong><br>üèõÔ∏è ${templeName}<br>üìÖ ${date}<br>‚è∞ ${chatState.bookingData.time_slot}<br>üë• ${chatState.bookingData.persons} people<br>üí∞ ‚Çπ${amount}<br><br>Confirm booking?</span></div>`;
    
    messages.innerHTML += `<div class="quick-replies mb-2">
        <button class="btn btn-success btn-sm me-1" onclick="sendQuickReply('Yes, confirm booking')">‚úÖ Confirm</button>
        <button class="btn btn-danger btn-sm me-1" onclick="sendQuickReply('No, cancel')">‚ùå Cancel</button>
    </div>`;
}

function createBooking(messages) {
    const bookingData = {
        ...chatState.bookingData,
        prasads: [],
        poojas: []
    };
    
    messages.innerHTML += `<div class="mb-2"><span class="badge bg-info px-3 py-2">üîÑ Creating booking...</span></div>`;
    
    fetch('/api/book', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-success px-3 py-2">‚úÖ Booking Created! Redirecting to payment...</span></div>`;
            setTimeout(() => {
                window.location.href = `/payment/${data.booking_id}`;
            }, 1500);
            chatState = { step: 'greeting', bookingData: {} };
        } else {
            messages.innerHTML += `<div class="mb-2"><span class="badge bg-danger px-3 py-2">‚ùå Booking failed. Please login first.</span></div>`;
        }
        messages.scrollTop = messages.scrollHeight;
    })
    .catch(() => {
        messages.innerHTML += `<div class="mb-2"><span class="badge bg-danger px-3 py-2">‚ùå Please login to book temples</span></div>`;
        messages.scrollTop = messages.scrollHeight;
    });
}

function handleCrowdQuery(messages) {
    messages.innerHTML += `<div class="mb-2"><span class="badge bg-info px-3 py-2">üìä Current crowd status: Most temples are Low to Medium. Best time to visit is early morning!</span></div>`;
}

function showHelp(messages) {
    messages.innerHTML += `<div class="mb-2"><span class="badge bg-secondary px-3 py-2">üìù <strong>Quick Commands:</strong><br>‚Ä¢ "Book Udupi Krishna temple tomorrow morning for 2 people"<br>‚Ä¢ "Book Hampi temple"<br>‚Ä¢ "Crowd status"<br>‚Ä¢ "Help"</span></div>`;
}

function sendQuickReply(reply) {
    document.getElementById('chatInput').value = reply;
    sendMessage();
}
</script>

<style>
.temple-card {
    transition: all 0.3s ease;
    border-radius: 20px !important;
}
.temple-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important;
}

.feature-card {
    transition: all 0.3s ease;
    border-radius: 20px !important;
}
.feature-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1) !important;
}



.bg-gradient-dark {
    background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%);
}

.hero-section {
    border-radius: 0 !important;
}

.animate-bounce {
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 53%, 80%, 100% {
        transform: translate3d(0,0,0);
    }
    40%, 43% {
        transform: translate3d(0,-15px,0);
    }
    70% {
        transform: translate3d(0,-7px,0);
    }
    90% {
        transform: translate3d(0,-2px,0);
    }
}

.backdrop-blur {
    backdrop-filter: blur(10px);
}

.text-shadow {
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

/* Chatbot scrollbar styling */
#chatMessages::-webkit-scrollbar {
    width: 6px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}