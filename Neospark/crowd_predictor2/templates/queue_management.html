{% extends "base.html" %}

{% block title %}Queue Management System - Temple Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-diagram-3"></i> Queue Management System</h2>
        <p class="text-muted">AI-powered queue monitoring and flow optimization</p>
    </div>
</div>

<!-- Queue Detection Panel -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-camera-video"></i> Live Queue Detection</h5>
            </div>
            <div class="card-body">
                <form id="queueDetectionForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Select Temple</label>
                        <select class="form-select" name="temple_id" id="templeSelect" required>
                            <option value="">Choose temple...</option>
                            {% for temple in temples %}
                            <option value="{{ temple.id }}">{{ temple.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Upload Queue Image</label>
                        <input type="file" class="form-control" name="file" accept="image/*" required>
                        <small class="text-muted">Upload image showing temple queue areas</small>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-play-circle"></i> Analyze Queues
                        </button>
                    </div>
                </form>
                
                <div id="detectionResults" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6>Queue Analysis Results:</h6>
                        <div id="queueCounts"></div>
                        <div id="queueImage" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-speedometer2"></i> Real-time Queue Status</h5>
            </div>
            <div class="card-body">
                <div id="queueStatusDisplay">
                    <div class="text-center text-muted">
                        <i class="bi bi-hourglass-split fs-1"></i>
                        <p>Select a temple and analyze queues to see status</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-outline-success btn-sm" onclick="refreshQueueStatus()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Status
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Queue Analytics Dashboard -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5><i class="bi bi-graph-up"></i> Queue Analytics & Flow Optimization</h5>
            </div>
            <div class="card-body">
                <div class="row" id="queueAnalytics">
                    <!-- Queue metrics will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Queue Flow Visualization -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-diagram-2"></i> Queue Flow Diagram</h5>
            </div>
            <div class="card-body">
                <div id="queueFlowDiagram" class="text-center">
                    <svg width="100%" height="300" id="flowSvg">
                        <!-- Flow diagram will be drawn here -->
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recommendations Panel -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h5><i class="bi bi-exclamation-triangle"></i> Queue Alerts</h5>
            </div>
            <div class="card-body">
                <div id="queueAlerts">
                    <div class="text-muted text-center">
                        <i class="bi bi-shield-check fs-1"></i>
                        <p>No active alerts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h5><i class="bi bi-lightbulb"></i> Optimization Suggestions</h5>
            </div>
            <div class="card-body">
                <div id="optimizationSuggestions">
                    <div class="text-muted text-center">
                        <i class="bi bi-gear fs-1"></i>
                        <p>Analyze queues to get optimization suggestions</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Queue Configuration Modal -->
<div class="modal fade" id="queueConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Queue Zones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Configure queue zones for better detection accuracy:</p>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Entry Queue Zone</h6>
                        <div class="mb-2">
                            <label>X1:</label> <input type="number" class="form-control form-control-sm" id="entryX1" value="0">
                        </div>
                        <div class="mb-2">
                            <label>Y1:</label> <input type="number" class="form-control form-control-sm" id="entryY1" value="0">
                        </div>
                        <div class="mb-2">
                            <label>X2:</label> <input type="number" class="form-control form-control-sm" id="entryX2" value="200">
                        </div>
                        <div class="mb-2">
                            <label>Y2:</label> <input type="number" class="form-control form-control-sm" id="entryY2" value="300">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Darshan Queue Zone</h6>
                        <div class="mb-2">
                            <label>X1:</label> <input type="number" class="form-control form-control-sm" id="darshanX1" value="200">
                        </div>
                        <div class="mb-2">
                            <label>Y1:</label> <input type="number" class="form-control form-control-sm" id="darshanY1" value="0">
                        </div>
                        <div class="mb-2">
                            <label>X2:</label> <input type="number" class="form-control form-control-sm" id="darshanX2" value="400">
                        </div>
                        <div class="mb-2">
                            <label>Y2:</label> <input type="number" class="form-control form-control-sm" id="darshanY2" value="300">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQueueConfig()">Save Configuration</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTempleId = null;
let queueData = null;

// Queue Detection Form Handler
document.getElementById('queueDetectionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    currentTempleId = formData.get('temple_id');
    
    // Show loading
    document.getElementById('detectionResults').style.display = 'none';
    
    fetch('/api/queue-detection', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayQueueResults(data);
            updateQueueStatus(data.queue_status);
            updateQueueAnalytics(data.queue_status);
            drawQueueFlow(data.queue_status);
            updateRecommendations(data.queue_status);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Detection failed: ' + error.message);
    });
});

function displayQueueResults(data) {
    const countsHtml = `
        <div class="row text-center">
            <div class="col-3">
                <div class="badge bg-primary fs-6">Entry: ${data.zone_counts.entry}</div>
            </div>
            <div class="col-3">
                <div class="badge bg-success fs-6">Darshan: ${data.zone_counts.darshan}</div>
            </div>
            <div class="col-3">
                <div class="badge bg-warning fs-6">Prasad: ${data.zone_counts.prasad}</div>
            </div>
            <div class="col-3">
                <div class="badge bg-info fs-6">Exit: ${data.zone_counts.exit}</div>
            </div>
        </div>
    `;
    
    document.getElementById('queueCounts').innerHTML = countsHtml;
    
    if (data.annotated_image) {
        document.getElementById('queueImage').innerHTML = 
            `<img src="/static/${data.annotated_image}" class="img-fluid rounded" alt="Queue Analysis">`;
    }
    
    document.getElementById('detectionResults').style.display = 'block';
}

function updateQueueStatus(queueStatus) {
    if (!queueStatus) return;
    
    const statusHtml = `
        <div class="row">
            <div class="col-12 mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6>Total People: ${queueStatus.total_people}</h6>
                    <span class="badge bg-${queueStatus.crowd_level === 'Low' ? 'success' : queueStatus.crowd_level === 'Medium' ? 'warning' : 'danger'} fs-6">
                        ${queueStatus.crowd_level}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-6 mb-2">
                <div class="card border-primary">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title mb-1">Entry Queue</h6>
                        <div class="badge bg-${queueStatus.queues.entry.status === 'Low' ? 'success' : queueStatus.queues.entry.status === 'Medium' ? 'warning' : 'danger'}">
                            ${queueStatus.queues.entry.count} people
                        </div>
                        <div class="small text-muted">Wait: ${queueStatus.queues.entry.wait_time} min</div>
                    </div>
                </div>
            </div>
            <div class="col-6 mb-2">
                <div class="card border-success">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title mb-1">Darshan Queue</h6>
                        <div class="badge bg-${queueStatus.queues.darshan.status === 'Low' ? 'success' : queueStatus.queues.darshan.status === 'Medium' ? 'warning' : 'danger'}">
                            ${queueStatus.queues.darshan.count} people
                        </div>
                        <div class="small text-muted">Wait: ${queueStatus.queues.darshan.wait_time} min</div>
                    </div>
                </div>
            </div>
            <div class="col-6 mb-2">
                <div class="card border-warning">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title mb-1">Prasad Queue</h6>
                        <div class="badge bg-${queueStatus.queues.prasad.status === 'Low' ? 'success' : queueStatus.queues.prasad.status === 'Medium' ? 'warning' : 'danger'}">
                            ${queueStatus.queues.prasad.count} people
                        </div>
                        <div class="small text-muted">Wait: ${queueStatus.queues.prasad.wait_time} min</div>
                    </div>
                </div>
            </div>
            <div class="col-6 mb-2">
                <div class="card border-info">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title mb-1">Flow Rate</h6>
                        <div class="badge bg-info">
                            ${Math.round(queueStatus.total_people / 10)} ppl/min
                        </div>
                        <div class="small text-muted">Processing</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('queueStatusDisplay').innerHTML = statusHtml;
    queueData = queueStatus;
}

function updateQueueAnalytics(queueStatus) {
    if (!queueStatus) return;
    
    const analyticsHtml = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-primary">${queueStatus.total_people}</h5>
                    <p class="mb-0">Total People</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-success">${Math.max(...Object.values(queueStatus.queues).map(q => q.wait_time))}</h5>
                    <p class="mb-0">Max Wait (min)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-warning">${Object.values(queueStatus.queues).filter(q => q.status === 'High').length}</h5>
                    <p class="mb-0">Bottlenecks</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-info">${Math.round((queueStatus.total_people / 100) * 100)}%</h5>
                    <p class="mb-0">Capacity Usage</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('queueAnalytics').innerHTML = analyticsHtml;
}

function drawQueueFlow(queueStatus) {
    if (!queueStatus) return;
    
    const svg = document.getElementById('flowSvg');
    svg.innerHTML = '';
    
    // Create flow diagram
    const width = svg.clientWidth || 800;
    const height = 300;
    
    // Queue boxes
    const queues = [
        { name: 'Entry', x: 50, y: 100, count: queueStatus.queues.entry.count, status: queueStatus.queues.entry.status },
        { name: 'Darshan', x: 250, y: 100, count: queueStatus.queues.darshan.count, status: queueStatus.queues.darshan.status },
        { name: 'Prasad', x: 450, y: 100, count: queueStatus.queues.prasad.count, status: queueStatus.queues.prasad.status },
        { name: 'Exit', x: 650, y: 100, count: 0, status: 'Low' }
    ];
    
    // Draw connections
    for (let i = 0; i < queues.length - 1; i++) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', queues[i].x + 80);
        line.setAttribute('y1', queues[i].y + 25);
        line.setAttribute('x2', queues[i + 1].x);
        line.setAttribute('y2', queues[i + 1].y + 25);
        line.setAttribute('stroke', '#007bff');
        line.setAttribute('stroke-width', '3');
        line.setAttribute('marker-end', 'url(#arrowhead)');
        svg.appendChild(line);
    }
    
    // Draw queue boxes
    queues.forEach(queue => {
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', queue.x);
        rect.setAttribute('y', queue.y);
        rect.setAttribute('width', '80');
        rect.setAttribute('height', '50');
        rect.setAttribute('fill', queue.status === 'Low' ? '#28a745' : queue.status === 'Medium' ? '#ffc107' : '#dc3545');
        rect.setAttribute('stroke', '#333');
        rect.setAttribute('stroke-width', '2');
        rect.setAttribute('rx', '5');
        svg.appendChild(rect);
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', queue.x + 40);
        text.setAttribute('y', queue.y + 20);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'white');
        text.setAttribute('font-weight', 'bold');
        text.textContent = queue.name;
        svg.appendChild(text);
        
        const count = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        count.setAttribute('x', queue.x + 40);
        count.setAttribute('y', queue.y + 35);
        count.setAttribute('text-anchor', 'middle');
        count.setAttribute('fill', 'white');
        count.setAttribute('font-size', '12');
        count.textContent = queue.count + ' people';
        svg.appendChild(count);
    });
    
    // Add arrow marker
    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
    marker.setAttribute('id', 'arrowhead');
    marker.setAttribute('markerWidth', '10');
    marker.setAttribute('markerHeight', '7');
    marker.setAttribute('refX', '9');
    marker.setAttribute('refY', '3.5');
    marker.setAttribute('orient', 'auto');
    
    const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
    polygon.setAttribute('fill', '#007bff');
    
    marker.appendChild(polygon);
    defs.appendChild(marker);
    svg.appendChild(defs);
}

function updateRecommendations(queueStatus) {
    if (!queueStatus) return;
    
    // Update alerts
    const alerts = [];
    Object.entries(queueStatus.queues).forEach(([queueName, queueInfo]) => {
        if (queueInfo.status === 'High') {
            alerts.push(`${queueName.charAt(0).toUpperCase() + queueName.slice(1)} queue is overcrowded (${queueInfo.count} people, ${queueInfo.wait_time} min wait)`);
        }
    });
    
    if (alerts.length > 0) {
        const alertsHtml = alerts.map(alert => 
            `<div class="alert alert-danger alert-sm mb-2">
                <i class="bi bi-exclamation-triangle"></i> ${alert}
            </div>`
        ).join('');
        document.getElementById('queueAlerts').innerHTML = alertsHtml;
    } else {
        document.getElementById('queueAlerts').innerHTML = 
            `<div class="text-success text-center">
                <i class="bi bi-shield-check fs-1"></i>
                <p>All queues operating normally</p>
            </div>`;
    }
    
    // Update suggestions
    const suggestions = queueStatus.recommendations || [];
    if (suggestions.length > 0) {
        const suggestionsHtml = suggestions.map(suggestion => 
            `<div class="alert alert-info alert-sm mb-2">
                <i class="bi bi-lightbulb"></i> ${suggestion}
            </div>`
        ).join('');
        document.getElementById('optimizationSuggestions').innerHTML = suggestionsHtml;
    } else {
        document.getElementById('optimizationSuggestions').innerHTML = 
            `<div class="text-muted text-center">
                <i class="bi bi-gear fs-1"></i>
                <p>No optimization needed</p>
            </div>`;
    }
}

function refreshQueueStatus() {
    if (currentTempleId) {
        fetch(`/api/queue-status/${currentTempleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateQueueStatus(data.queue_status);
                updateQueueAnalytics(data.queue_status);
                drawQueueFlow(data.queue_status);
                updateRecommendations(data.queue_status);
            }
        })
        .catch(error => console.error('Error refreshing status:', error));
    }
}

function saveQueueConfig() {
    if (!currentTempleId) {
        alert('Please select a temple first');
        return;
    }
    
    const config = {
        temple_id: currentTempleId,
        zones: {
            entry: [
                parseInt(document.getElementById('entryX1').value),
                parseInt(document.getElementById('entryY1').value),
                parseInt(document.getElementById('entryX2').value),
                parseInt(document.getElementById('entryY2').value)
            ],
            darshan: [
                parseInt(document.getElementById('darshanX1').value),
                parseInt(document.getElementById('darshanY1').value),
                parseInt(document.getElementById('darshanX2').value),
                parseInt(document.getElementById('darshanY2').value)
            ]
        }
    };
    
    fetch('/api/queue-config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Queue configuration saved successfully');
            bootstrap.Modal.getInstance(document.getElementById('queueConfigModal')).hide();
        } else {
            alert('Error saving configuration: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save configuration');
    });
}

// Auto-refresh every 30 seconds
setInterval(refreshQueueStatus, 30000);
</script>

<style>
.alert-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.card-body.p-2 {
    padding: 0.5rem !important;
}

#flowSvg {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}
</style>
{% endblock %}